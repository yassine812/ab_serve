{% extends 'gamme/admin_base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card card-info card-outline">
                
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label for="intitule" class="form-label fw-bold">Titre de la mission</label>
                                    <input type="text" class="form-control form-control-lg" id="intitule" name="intitule" 
                                           value="{{ mission.intitule }}" required readonly>
                                    
                                </div>
                            </div>
                            
                        </div>

                        <div class="form-group mb-4">
                            <label for="description" class="form-label fw-bold">Description détaillée</label>
                            <textarea class="form-control" id="description" name="description" 
                                     rows="4" required readonly>{{ mission.description }}</textarea>
                            
                        </div>

                        

                        

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'Gamme:operateur_dashboard' %}" class="btn btn-lg btn-secondary">
                                <i class="fas fa-arrow-left"></i> Retour
                            </a>
                            <div class="btn-group" role="group">
                                <div class="btn-group" role="group">
                                    <a href="{% url 'Gamme:view_gamme_pdf' mission.id %}" class="btn btn-info me-2" target="_blank">
                                        <i class="fas fa-eye"></i> Voir les gammes
                                    </a>
                                    <a href="{% url 'Gamme:view_gamme_pdf' mission.id %}?download=1" class="btn btn-success">
                                        <i class="fas fa-download"></i> Télécharger PDF
                                    </a>
                                </div>
                                <!-- PDF Viewer Modal -->
                                <div class="modal fade" id="pdfViewerModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 95%; height: 95vh;">
                                        <div class="modal-content h-100">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Visualisation de la gamme - {{ mission.code }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body p-0 d-flex flex-column">
                                                <div class="d-flex justify-content-center align-items-center bg-light" style="height: 100%; min-height: 70vh;">
                                                    <div id="pdfLoading" class="text-center p-5">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Chargement...</span>
                                                        </div>
                                                        <p class="mt-2">Chargement du PDF en cours...</p>
                                                    </div>
                                                    <iframe id="pdfViewer" 
                                                            src="" 
                                                            style="width: 100%; height: 100%; min-height: 70vh; border: none; display: none;"
                                                            onload="document.getElementById('pdfLoading').style.display='none'; this.style.display='block';">
                                                    </iframe>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <a id="downloadPdfBtn" href="#" class="btn btn-primary" download>
                                                    <i class="fas fa-download"></i> Télécharger
                                                </a>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <script>
                                // Function to open PDF in modal
                                function viewGammePDF(pdfUrl) {
                                    const modal = new bootstrap.Modal(document.getElementById('pdfViewerModal'));
                                    const pdfViewer = document.getElementById('pdfViewer');
                                    const downloadBtn = document.getElementById('downloadPdfBtn');
                                    const loadingDiv = document.getElementById('pdfLoading');
                                    
                                    // Reset state
                                    loadingDiv.style.display = 'flex';
                                    loadingDiv.style.flexDirection = 'column';
                                    loadingDiv.style.justifyContent = 'center';
                                    loadingDiv.style.alignItems = 'center';
                                    loadingDiv.style.height = '70vh';
                                    loadingDiv.innerHTML = `
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Chargement...</span>
                                        </div>
                                        <p class="mt-3">Préparation du PDF en cours...</p>
                                    `;
                                    pdfViewer.style.display = 'none';
                                    
                                    // Create a clean URL for the PDF to avoid caching issues
                                    const timestamp = new Date().getTime();
                                    const cleanPdfUrl = pdfUrl + (pdfUrl.includes('?') ? '&' : '?') + 't=' + timestamp;
                                    
                                    // Function to handle successful PDF load
                                    function onPdfLoad() {
                                        loadingDiv.style.display = 'none';
                                        pdfViewer.style.display = 'block';
                                        
                                        // Set up download button to open in new tab
                                        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Télécharger le PDF';
                                        downloadBtn.className = 'btn btn-danger';
                                        downloadBtn.onclick = function(e) {
                                            e.preventDefault();
                                            // Open in new tab for download
                                            const newWindow = window.open(cleanPdfUrl, '_blank');
                                            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                                                // If popup was blocked, redirect current page
                                                window.location.href = cleanPdfUrl;
                                            }
                                        };
                                    }
                                    
                                    // Function to handle PDF load error
                                    function onPdfError() {
                                        loadingDiv.innerHTML = `
                                            <div class="alert alert-danger text-center">
                                                <i class="fas fa-exclamation-triangle fa-2x mb-2 d-block"></i>
                                                <h5>Erreur lors du chargement du PDF</h5>
                                                <p class="mb-3">Le PDF n'a pas pu être chargé. Veuillez réessayer.</p>
                                                <button class="btn btn-primary" onclick="window.open('${cleanPdfUrl}', '_blank')">
                                                    <i class="fas fa-external-link-alt"></i> Ouvrir dans un nouvel onglet
                                                </button>
                                                <button class="btn btn-secondary mt-2" onclick="location.reload()">
                                                    <i class="fas fa-sync"></i> Réessayer
                                                </button>
                                            </div>
                                        `;
                                    }
                                    
                                    // Set up event listeners
                                    pdfViewer.onload = onPdfLoad;
                                    pdfViewer.onerror = onPdfError;
                                    
                                    // Set a timeout in case the PDF takes too long to load
                                    const loadTimeout = setTimeout(() => {
                                        if (loadingDiv.style.display !== 'none') {
                                            onPdfError();
                                        }
                                    }, 30000); // 30 seconds timeout
                                    
                                    // Clear timeout if PDF loads successfully
                                    pdfViewer.onload = function() {
                                        clearTimeout(loadTimeout);
                                        onPdfLoad();
                                    };
                                    
                                    // Set the source and show modal
                                    pdfViewer.src = cleanPdfUrl;
                                    modal.show();
                                    
                                    // Set PDF source
                                    pdfViewer.onload = function() {
                                        loadingDiv.style.display = 'none';
                                        pdfViewer.style.display = 'block';
                                        pdfViewer.focus();
                                        
                                        // Wait a bit more to ensure PDF is fully rendered
                                        setTimeout(setupDownloadButton, 1000);
                                    };
                                    
                                    // Handle PDF loading errors
                                    pdfViewer.onerror = function() {
                                        loadingDiv.innerHTML = `
                                            <div class="alert alert-danger">
                                                <i class="fas fa-exclamation-triangle"></i> 
                                                Erreur lors du chargement du PDF. 
                                                <a href="${cleanPdfUrl}" class="alert-link" target="_blank">
                                                    Essayer d'ouvrir dans un nouvel onglet
                                                </a>
                                            </div>
                                        `;
                                        downloadBtn.disabled = true;
                                    };
                                    
                                    // Set the source after setting up event handlers
                                    pdfViewer.src = cleanPdfUrl;
                                    
                                    // Show modal
                                    modal.show();
                                }
                                
                                // Add click handler to the Voir les gammes button
                                document.querySelector('a[href*="view_gamme_pdf"]').addEventListener('click', function(e) {
                                    e.preventDefault();
                                    viewGammePDF(this.href);
                                });
                                </script>
                               
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



{% block extra_js %}
{% endblock %}
{% endblock %}
