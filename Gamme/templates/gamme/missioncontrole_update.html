{% extends 'Gamme/admin_base.html' %}
{% load static %}

{% block content %}
<form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
  {% csrf_token %}
  <style>
    .photo-cell {
      text-align: center;
      margin-bottom: 10px;
      position: relative;
      display: inline-block;
    }
    .operation-photo {
      max-width: 60px;
      max-height: 60px;
      cursor: pointer;
      border: 2px solid #fff;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    .operation-photo:hover {
      transform: scale(1.1);
      border-color: #007bff;
      box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
    }
    .photo-description {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
      width: 100%;
      text-align: left;
    }
    .photo-description input {
      border: none;
      background: transparent;
      border-bottom: 1px solid #ddd;
      width: 100%;
      padding: 2px 0;
      font-size: 0.8em;
    }
    .photo-description input:focus {
      outline: none;
      border-bottom-color: #007bff;
    }
    .photo-delete-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      transition: all 0.2s ease;
    }
    .photo-cell:hover .photo-delete-btn {
      display: block;
    }
    .photo-delete-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }
    .photo-forms-container {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      min-height: 60px;
      position: relative;
    }
    .photo-add-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .photo-add-btn.disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.65;
    }
    .photo-add-btn:hover {
      background: #0056b3;
      transform: scale(1.1);
    }
    .photo-add-btn i {
      margin: 0;
    }
   
    .zoom-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
    }
    .zoom-image {
      max-width: 90%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 4px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }
    .zoom-description {
      color: #fff;
      margin-top: 1rem;
      font-size: 1.1rem;
      text-align: center;
      max-width: 90%;
      word-break: break-word;
    }
    .zoom-close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      z-index: 1010;
    }
  </style>

  <ul class="nav nav-tabs" id="custom-tabs-four-tab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="custom-tabs-four-home-tab" data-bs-toggle="pill" href="#custom-tabs-four-home" role="tab">Mission</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="custom-tabs-four-profile-tab" data-bs-toggle="pill" href="#custom-tabs-four-profile" role="tab">Gamme</a>
    </li>
  </ul>

  <div class="tab-content" id="custom-tabs-four-tabContent">
    <!-- Mission -->
    <div class="tab-pane fade show active" id="custom-tabs-four-home" role="tabpanel">
      <div class="card card-info card-outline mb-4">
        <div class="card-header"><div class="card-title">Mission</div></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Code</label>
              <input type="text" class="form-control" name="code" value="{{ missioncontrole.code }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Intitulé</label>
              <input type="text" class="form-control" name="intitule" value="{{ missioncontrole.intitule }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Référence Produit</label>
              <input type="text" class="form-control" name="produitref" value="{{ missioncontrole.produitref }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Statut</label>
              <select class="form-select" name="statut">
                <option value="True" {% if missioncontrole.statut %}selected{% endif %}>Actif</option>
                <option value="False" {% if not missioncontrole.statut %}selected{% endif %}>Inactif</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gamme -->
    <div class="tab-pane fade" id="custom-tabs-four-profile" role="tabpanel">
      <div class="card card-info card-outline mb-4">
        <div class="card-header"><div class="card-title">Gammes Associées</div></div>
        <div class="card-body">

          {% if gammes %}
          <div class="accordion" id="accordionGammes">
            {% for gamme in gammes %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingGamme{{ forloop.counter }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGamme{{ forloop.counter }}">
                  {{ gamme.intitule }} — Version {{ gamme.version }} — {% if gamme.statut %}✔️ Actif{% else %}❌ Inactif{% endif %}
                </button>
              </h2>
              <div id="collapseGamme{{ forloop.counter }}" class="accordion-collapse collapse">
                <div class="accordion-body">

                  {% if forloop.first %}
                  <div class="d-flex gap-2 mb-3">
                    <a class="btn btn-sm btn-outline-warning" data-bs-toggle="collapse" href="#formGamme{{ gamme.id }}">
                      <i class="bi bi-pencil"></i> Modifier cette gamme
                    </a>

                    <a class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" href="#operationsGamme{{ gamme.id }}">
                      Modifier les opérations
                    </a>

                    <button type="button" class="btn btn-sm btn-outline-success" onclick="showAddOperationForm('{{ gamme.id }}')">
                      <i class="bi bi-plus-circle"></i> Ajouter opération
                    </button>

                    <a class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" href="#tableOperationsGamme{{ gamme.id }}">
                      Afficher les opérations
                    </a>
                  </div>

                  <!-- Modifier gamme -->
                  <div class="collapse mb-3" id="formGamme{{ gamme.id }}">
                    <div class="card card-light">
                      <div class="card-body">
                        <div class="mb-3">
                          <label class="form-label">Intitulé</label>
                          <input type="text" class="form-control" name="{{ gamme.id }}-intitule" value="{{ gamme.intitule }}">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">No Incident</label>
                          <input type="text" class="form-control" name="{{ gamme.id }}-No_incident" value="{{ gamme.No_incident }}">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Statut</label>
                          <select class="form-select" name="{{ gamme.id }}-statut">
                            <option value="True" {% if gamme.statut %}selected{% endif %}>Actif</option>
                            <option value="False" {% if not gamme.statut %}selected{% endif %}>Inactif</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Table des opérations -->
                  <div class="collapse mb-3" id="operationsGamme{{ gamme.id }}">
                    <div class="table-responsive">
                      <table class="table table-striped table-bordered align-middle text-center">
                        <thead class="table-light">
                          <tr>
                            <th style="width: 15%;">Titre</th>
                            <th style="width: 10%;">Ordre</th>
                            <th style="width: 20%;">Description</th>
                            <th style="width: 20%;">Critères</th>
                            <th style="width: 20%;">Photos</th>
                            <th style="width: 15%;">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for op in gamme.operationcontrole_set.all %}
                          <tr data-op-id="{{ op.id }}">
                            <td>
                              <input type="text" class="form-control form-control-sm" name="{{ op.id }}-titre" value="{{ op.titre }}">
                            </td>
                            <td>
                              <input type="number" class="form-control form-control-sm" name="{{ op.id }}-ordre" value="{{ op.ordre }}">
                            </td>
                            <td>
                              <textarea class="form-control form-control-sm" rows="2" name="{{ op.id }}-description">{{ op.description }}</textarea>
                            </td>
                            <td>
                              <textarea class="form-control form-control-sm" rows="2" name="{{ op.id }}-criteres">{{ op.criteres }}</textarea>
                            </td>
                            <td>
                              <div class="photo-forms-container d-flex flex-wrap gap-2 justify-content-center">
                                {% for photo in op.photooperation_set.all %}
                                <div class="photo-cell" id="photoCell-{{ photo.id }}">
                                  <img src="{{ photo.image.url }}" class="operation-photo" alt="Photo de l'opération" onclick="zoomPhoto(this)">
                                  <div class="photo-description">
                                    <input type="text" class="form-control form-control-sm" name="photo_{{ photo.id }}_description" value="{{ photo.description }}">
                                  </div>
                                  <button type="button" class="photo-delete-btn" onclick="markPhotoDelete('{{ photo.id }}', this)">
                                    <i class="bi bi-x-lg"></i>
                                  </button>
                                </div>
                                {% endfor %}
                                <div id="newPhotoFormsContainer-{{ op.id }}"></div>
                                <button type="button" class="photo-add-btn" onclick="addNewPhotoForm('{{ op.id }}')" id="addPhotoBtn{{ op.id }}">
                                  <i class="bi bi-plus-lg"></i>
                                </button>
                              </div>
                            </td>
                            <td>
                              <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOperation('{{ op.id }}')">
                                <i class="bi bi-trash"></i> Supprimer
                              </button>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                      
                    </div>
                  </div>

                  <!-- Ajouter opération (formulaire) -->
                  <div class="collapse mb-3" id="addOperationGamme{{ gamme.id }}">
                    <div class="card card-light mb-3 operation-form" id="newOpForm-{{ gamme.id }}-0">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                          <h6 class="card-title">Nouvelle opération</h6>
                          <button type="button" class="btn-close" onclick="removeOperationForm(this)"></button>
                        </div>
                        <div class="d-flex flex-column gap-3">
                          <div>
                            <label class="form-label">Titre</label>
                            <input type="text" class="form-control" name="newop_{{ gamme.id }}_0_titre">
                          </div>
                          <div>
                            <label class="form-label">Ordre</label>
                            <input type="number" class="form-control" name="newop_{{ gamme.id }}_0_ordre">
                          </div>
                          <div>
                            <label class="form-label">Description</label>
                            <textarea class="form-control" rows="3" name="newop_{{ gamme.id }}_0_description"></textarea>
                          </div>
                          <div>
                            <label class="form-label">Critères</label>
                            <textarea class="form-control" rows="3" name="newop_{{ gamme.id }}_0_criteres"></textarea>
                          </div>
                        </div>

                        <!-- Container new photos for this new op -->
                        <div class="photo-forms-container" id="newOpPhotoFormsContainer-{{ gamme.id }}_0"></div>

                        <button type="button" class="btn btn-outline-secondary btn-sm mt-3" 
                                onclick="event.stopPropagation(); addNewOpPhotoForm('{{ gamme.id }}', 0, event)" 
                                id="addNewOpPhotoBtn{{ gamme.id }}_0">
                          <i class="bi bi-camera"></i> Ajouter une photo
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Table opérations -->
                  <div class="collapse" id="tableOperationsGamme{{ gamme.id }}">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Titre</th>
                          <th>Ordre</th>
                          <th>Description</th>
                          <th>Critères</th>
                          <th>Photo</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for op in gamme.operationcontrole_set.all %}
                        <tr data-op-id="{{ op.id }}">
                          <td>{{ op.titre }}</td>
                          <td>{{ op.ordre }}</td>
                          <td>{{ op.description }}</td>
                          <td>{{ op.criteres }}</td>
                          <td>
                            {% if op.photooperation_set.all %}
                              {% for photo in op.photooperation_set.all %}
                              <div class="photo-cell">
                                <img src="{{ photo.image.url }}" class="operation-photo" alt="Photo de l'opération" onclick="zoomPhoto(this)">
                                <div class="photo-description">{{ photo.description }}</div>
                              </div>
                              {% endfor %}
                            {% else %}
                              <span class="text-muted">Pas de photo</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>

                  {% else %}
                  <!-- Non-last gammes: only show afficher les opérations -->
                  <div class="d-flex gap-2 mb-3">
                    <a class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" href="#tableOperationsGamme{{ gamme.id }}">
                      Afficher les opérations
                    </a>
                  </div>
                  <div class="collapse" id="tableOperationsGamme{{ gamme.id }}">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Titre</th>
                          <th>Ordre</th>
                          <th>Description</th>
                          <th>Critères</th>
                          <th>Photo</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for op in gamme.operationcontrole_set.all %}
                        <tr data-op-id="{{ op.id }}">
                          <td>{{ op.titre }}</td>
                          <td>{{ op.ordre }}</td>
                          <td>{{ op.description }}</td>
                          <td>{{ op.criteres }}</td>
                          <td>
                            {% if op.photooperation_set.all %}
                              {% for photo in op.photooperation_set.all %}
                              <div class="photo-cell">
                                <img src="{{ photo.image.url }}" class="operation-photo" alt="Photo de l'opération" onclick="zoomPhoto(this)">
                                <div class="photo-description">{{ photo.description }}</div>
                              </div>
                              {% endfor %}
                            {% else %}
                              <span class="text-muted">Pas de photo</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% endif %}

                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center">
            <p class="text-muted">Aucune gamme associée.</p>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="collapse" data-bs-target="#newGammeForm">
              <i class="bi bi-plus-circle"></i> Ajouter une nouvelle gamme
            </button>
          </div>
          {% endif %}

          <!-- Nouvelle gamme -->
          <div class="collapse mt-4" id="newGammeForm">
            <h5>Nouvelle Gamme</h5>
            <div class="mb-3">
              <label class="form-label">Intitulé</label>
              <input type="text" class="form-control" name="gamme_intitule">
            </div>
            <div class="mb-3">
              <label class="form-label">No Incident</label>
              <input type="text" class="form-control" name="gamme_No_incident">
            </div>
            <div class="mb-3">
              <label class="form-label">Statut</label>
              <select class="form-select" name="gamme_statut">
                <option value="True">Actif</option>
                <option value="False">Inactif</option>
              </select>
            </div>

            {{ operation_formset.management_form }}
            <div id="operation-forms-container">
              {% for form in operation_formset %}
              <div class="card card-light mb-3 operation-form" id="newOpForm-{{ forloop.counter0 }}">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="card-title">Opération</h6>
                    <button type="button" class="btn-close" onclick="removeOperationForm(this)"></button>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Titre</label>
                      {{ form.titre }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ordre</label>
                      {{ form.ordre }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Description</label>
                      {{ form.description }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Critères</label>
                      {{ form.criteres }}
                    </div>
                  </div>

                  <!-- Container new photos for this new form op -->
                  <div class="photo-forms-container" id="newOpPhotoFormsContainerForm{{ forloop.counter0 }}"></div>

                  <button type="button" class="btn btn-outline-secondary btn-sm mt-3" 
                          onclick="event.stopPropagation(); addNewOpPhotoFormForForm('{{ forloop.counter0 }}', event);" 
                          id="addNewOpPhotoBtnForm{{ forloop.counter0 }}">
                    <i class="bi bi-camera"></i> Ajouter une photo
                  </button>
                </div>
              </div>
              {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-primary" onclick="addOperationForm()">
              Ajouter une opération
            </button>
          </div>

        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
          <a href="{% url 'Gamme:missioncontrole_list' %}" class="btn btn-secondary">Annuler</a>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Zoom overlay -->
<div class="zoom-overlay" id="photoZoom" role="dialog" aria-modal="true" aria-labelledby="zoomedImage">
  <button class="zoom-close-btn" aria-label="Close zoom" onclick="closeZoom()">×</button>
  <img src="" class="zoom-image" id="zoomedImage" alt="Photo agrandie">
  <div class="zoom-description"></div>
</div>

<script>
  let photoCount = {};
  let newOpCount = 1; // for new ops in new gamme form
  let newOpPhotoCount = {};

  // Remove operation function
  function removeOperation(opId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette opération ?')) {
      const url = `/gamme/operationcontrole/${opId}/delete/`;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
      })
      .then(response => {
        if (response.ok) {
            // Remove the row from the editable table
            const row = document.querySelector(`tr[data-op-id="${opId}"]`);
            if (row) {
              row.remove();
            }
            // Also remove the row from the display-only table
            const displayRow = document.querySelector(`#tableOperationsGamme{{ gamme.id }} tr[data-op-id="${opId}"]`);
            if (displayRow) {
              displayRow.remove();
            }
          } else {
          alert('Erreur lors de la suppression de l\'opération.');
        }
      })
      .catch(error => console.error('Error:', error));
    }
  }

  // Add new photo input for existing operation
  function addNewPhotoForm(opId) {
    const container = document.getElementById(`newPhotoFormsContainer-${opId}`);
    if (!container) return;

    const photoCellContainer = container.closest('.photo-forms-container');
    const existingPhotos = photoCellContainer.querySelectorAll('.photo-cell:not([style*="display: none"])').length;

    if (existingPhotos >= 5) {
        alert('Maximum de 5 photos par opération atteint');
        return;
    }

    const newPhotoId = newOpPhotoCount[opId] || 0;
    const newPhotoForm = document.createElement('div');
    newPhotoForm.className = 'photo-cell';
    newPhotoForm.id = `newPhoto-${opId}-${newPhotoId}`;
    newPhotoForm.innerHTML = `
      <input type="file" class="form-control-file" name="photo_${opId}_${newPhotoId}_image" accept="image/*" required>
      <div class="photo-description">
        <input type="text" class="form-control form-control-sm" name="photo_${opId}_${newPhotoId}_description" placeholder="Description" required>
      </div>
      <button type="button" class="photo-delete-btn" onclick="this.closest('.photo-cell').remove(); updatePhotoCounter('${opId}');">
        <i class="bi bi-x-lg"></i>
      </button>
    `;
    container.appendChild(newPhotoForm);
    newOpPhotoCount[opId] = newPhotoId + 1;
    updatePhotoCounter(opId);
  }

  // Add new photo input for new operation in gamme add form
  function addNewOpPhotoForm(gammeId, opIndex, event) {
    // Prevent multiple triggers
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    const container = document.getElementById(`newOpPhotoFormsContainer-${gammeId}_${opIndex}`);
    if (!container) return;

    // Count existing photos
    const photoCount = container.querySelectorAll('.photo-cell:not([style*="display: none"])').length;
    if (photoCount >= 5) {
      alert('Maximum de 5 photos par opération atteint');
      return;
    }

    const key = `${gammeId}_${opIndex}`;
    newOpPhotoCount[key] = newOpPhotoCount[key] || 0;

    const index = newOpPhotoCount[key]++;
    const inputNameImage = `newop_${gammeId}_${opIndex}_photo_${index}_image`;
    const inputNameDesc = `newop_${gammeId}_${opIndex}_photo_${index}_description`;

    const div = document.createElement('div');
    div.className = 'card mt-2 photo-cell';
    div.innerHTML = `
      <div class="card-body">
        <label class="form-label">Nouvelle photo</label>
        <input type="file" name="${inputNameImage}" class="form-control mb-2" accept="image/*" required>
        <input type="text" name="${inputNameDesc}" class="form-control" placeholder="Description de la photo">
        <button type="button" class="btn btn-outline-danger btn-sm mt-2" onclick="event.stopPropagation(); this.closest('.photo-cell').remove(); updatePhotoCounters();">Supprimer cette photo</button>
      </div>
    `;
    container.appendChild(div);
    updatePhotoCounters();
    
    // Return false to prevent default behavior
    return false;
  }

  // Add new photo input for operation formset in new gamme form
  function addNewOpPhotoFormForForm(opIndex, event) {
    // Prevent multiple triggers
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    const container = document.getElementById(`newOpPhotoFormsContainerForm${opIndex}`);
    if (!container) return;

    // Count existing photos
    const photoCount = container.querySelectorAll('.photo-cell:not([style*="display: none"])').length;
    if (photoCount >= 5) {
      alert('Maximum de 5 photos par opération atteint');
      return;
    }

    newOpPhotoCount[opIndex] = newOpPhotoCount[opIndex] || 0;

    const index = newOpPhotoCount[opIndex]++;
    const inputNameImage = `formop_${opIndex}_photo_${index}_image`;
    const inputNameDesc = `formop_${opIndex}_photo_${index}_description`;

    const div = document.createElement('div');
    div.className = 'card mt-2 photo-cell';
    div.innerHTML = `
      <div class="card-body">
        <label class="form-label">Nouvelle photo</label>
        <input type="file" name="${inputNameImage}" class="form-control mb-2" accept="image/*" required>
        <input type="text" name="${inputNameDesc}" class="form-control" placeholder="Description de la photo">
        <button type="button" class="btn btn-outline-danger btn-sm mt-2" onclick="event.stopPropagation(); this.closest('.photo-cell').remove(); updatePhotoCounters();">Supprimer cette photo</button>
      </div>
    `;
    container.appendChild(div);
    updatePhotoCounters();
    
    // Return false to prevent default behavior
    return false;
  }

  // Remove operation form (new only)
  function removeOperationForm(btn) {
    const card = btn.closest('.operation-form');
    if(card){
      card.remove();
    }
  }

  // Simple counter for operation forms
  let operationCounter = 0;

  // Add a new operation form
  function showAddOperationForm(gammeId) {
    operationCounter++;
    const container = document.getElementById(`addOperationGamme${gammeId}`);
    
    // Get the first form as a template
    const template = container.querySelector('.operation-form');
    if (!template) return;
    
    // Create a new form
    const newForm = template.cloneNode(true);
    newForm.id = `newOpForm-${gammeId}-${operationCounter}`;
    
    // Update all form fields
    const formInputs = newForm.querySelectorAll('input, textarea, select');
    formInputs.forEach(input => {
      if (input.name) {
        input.name = input.name.replace(/newop_\d+_\d+_/, `newop_${gammeId}_${operationCounter}_`);
      }
    });
    
    // Clear values
    formInputs.forEach(input => {
      if (input.type !== 'button' && input.type !== 'submit') {
        input.value = '';
      }
    });
    
    // Add after the last form
    container.appendChild(newForm);
    
    // Ensure the container is visible
    const bsCollapse = bootstrap.Collapse.getInstance(container) || new bootstrap.Collapse(container);
    if (!container.classList.contains('show')) {
      bsCollapse.show();
    }
  }

  // Add new operation form in "Nouvelle Gamme" form
  function addOperationForm() {
    const container = document.getElementById('operation-forms-container');
    if (!container) return;

    const formIndex = container.children.length;
    const div = document.createElement('div');
    div.className = 'card card-light mb-3 operation-form';
    div.id = `newOpForm-${formIndex}`;

    div.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h6 class="card-title">Opération</h6>
          <button type="button" class="btn-close" onclick="removeOperationForm(this)"></button>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Titre</label>
            <input type="text" name="form-${formIndex}-titre" class="form-control" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Ordre</label>
            <input type="number" name="form-${formIndex}-ordre" class="form-control" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Description</label>
            <textarea name="form-${formIndex}-description" class="form-control" required></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Critères</label>
            <textarea name="form-${formIndex}-criteres" class="form-control" required></textarea>
          </div>
        </div>
        <div class="photo-forms-container" id="newOpPhotoFormsContainerForm${formIndex}"></div>
        <button type="button" class="btn btn-outline-secondary btn-sm mt-3" onclick="addNewOpPhotoFormForForm(${formIndex})">
          <i class="bi bi-camera"></i> Ajouter une photo
        </button>
      </div>
    `;
    container.appendChild(div);

    // Update management form TOTAL_FORMS
    const totalFormsInput = document.querySelector('#id_form-TOTAL_FORMS');
    if(totalFormsInput){
      totalFormsInput.value = parseInt(totalFormsInput.value) + 1;
    }
  }

  // Mark photo for deletion (hide card and add hidden input)
  function markPhotoDelete(photoId, btn) {
    const photoCard = document.getElementById(`photoCell-${photoId}`);
    if(photoCard){
        photoCard.style.display = 'none';

        // Add hidden input to mark delete
        let input = document.createElement('input');
        input.type = 'hidden';
        input.name = `photo_${photoId}_DELETE`;
        input.value = 'on';

        photoCard.appendChild(input);
        const opId = photoCard.closest('.photo-forms-container').querySelector('[id^=newPhotoFormsContainer-]').id.split('-')[1];
        updatePhotoCounter(opId);
    }
  }

  // Zoom photo function
  function zoomPhoto(img) {
    const overlay = document.getElementById('photoZoom');
    const zoomedImage = document.getElementById('zoomedImage');
    const zoomDesc = overlay.querySelector('.zoom-description');

    zoomedImage.src = img.src;

    let desc = '';

    // For photos in table or card
    const photoCell = img.closest('.photo-cell');
    if (photoCell) {
      const descElem = photoCell.querySelector('.photo-description');
      if(descElem){
        desc = descElem.textContent;
      }
    } else {
      // For photos in form inputs: try to find sibling input description
      const cardBody = img.closest('.card-body');
      if (cardBody) {
        const inputDesc = cardBody.querySelector('input[type="text"]');
        if(inputDesc){
          desc = inputDesc.value;
        }
      }
    }

    zoomDesc.textContent = desc || '';

    overlay.style.display = 'flex';
  }

  function updatePhotoCounter(opId) {
    const container = document.getElementById(`newPhotoFormsContainer-${opId}`).closest('.photo-forms-container');
    const addButton = document.getElementById(`addPhotoBtn${opId}`);
    const visiblePhotos = container.querySelectorAll('.photo-cell:not([style*="display: none"])').length;

    let counter = container.querySelector('.photo-counter');
    if (!counter) {
        counter = document.createElement('small');
        counter.className = 'photo-counter text-muted d-block mt-1';
        container.appendChild(counter);
    }

    counter.textContent = `${visiblePhotos}/5 photos`;

    if (visiblePhotos >= 5) {
        addButton.disabled = true;
        addButton.classList.add('disabled');
    } else {
        addButton.disabled = false;
        addButton.classList.remove('disabled');
    }
  }

  // Initialize photo counters when page loads
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id^=newPhotoFormsContainer-]').forEach(container => {
        const opId = container.id.split('-')[1];
        updatePhotoCounter(opId);
    });
  });

  // Close zoom overlay
  function closeZoom() {
    const overlay = document.getElementById('photoZoom');
    overlay.style.display = 'none';
  }

  // Close zoom overlay by clicking outside image or description
  document.getElementById('photoZoom').addEventListener('click', function(e) {
    if(e.target === this) {
      closeZoom();
    }
  });
</script>

{% endblock %}