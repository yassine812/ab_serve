{% extends 'Gamme/admin_base.html' %}
{% load static %}

{% block content %}
<form method="post" enctype="multipart/form-data" id="missionForm" class="needs-validation">
  {% csrf_token %}
  <style>
    .photo-cell {
      text-align: center;
      margin-bottom: 10px;
      position: relative;
      display: inline-block;
    }
    .operation-photo {
      max-width: 60px;
      max-height: 60px;
      cursor: pointer;
      border: 2px solid #fff;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    .operation-photo:hover {
      transform: scale(1.1);
      border-color: #007bff;
      box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
    }
    .photo-description {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
      width: 100%;
      text-align: left;
    }
    .photo-description input {
      border: none;
      background: transparent;
      border-bottom: 1px solid #ddd;
      width: 100%;
      padding: 2px 0;
      font-size: 0.8em;
    }
    .photo-description input:focus {
      outline: none;
      border-bottom-color: #007bff;
    }
    .photo-delete-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      transition: all 0.2s ease;
    }
    .photo-cell:hover .photo-delete-btn {
      display: block;
    }
    .photo-delete-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }
    .photo-forms-container {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      min-height: 60px;
      position: relative;
    }
    .photo-add-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .photo-add-btn.disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.65;
    }
    .photo-add-btn:hover {
      background: #0056b3;
      transform: scale(1.1);
    }
    .photo-add-btn i {
      margin: 0;
    }
   
    .zoom-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
    }
    .zoom-image {
      max-width: 90%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 4px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }
    .zoom-description {
      color: #fff;
      margin-top: 1rem;
      font-size: 1.1rem;
      text-align: center;
      max-width: 90%;
      word-break: break-word;
    }
    .zoom-close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      z-index: 1010;
    }
  </style>

  <ul class="nav nav-tabs" id="custom-tabs-four-tab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="custom-tabs-four-home-tab" data-bs-toggle="pill" href="#custom-tabs-four-home" role="tab">Mission</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="custom-tabs-four-profile-tab" data-bs-toggle="pill" href="#custom-tabs-four-profile" role="tab">Gamme</a>
    </li>
  </ul>

  <div class="tab-content" id="custom-tabs-four-tabContent">
    <!-- Mission -->
    <div class="tab-pane fade show active" id="custom-tabs-four-home" role="tabpanel">
      <div class="card card-info card-outline mb-4">
        <div class="card-header"><div class="card-title">Mission</div></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Code</label>
              <input type="text" class="form-control" name="code" value="{{ missioncontrole.code }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Intitulé</label>
              <input type="text" class="form-control" name="intitule" value="{{ missioncontrole.intitule }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Référence Produit</label>
              <input type="text" class="form-control" name="produitref" value="{{ missioncontrole.produitref }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Statut</label>
              <select class="form-select" name="statut">
                <option value="True" {% if missioncontrole.statut %}selected{% endif %}>Actif</option>
                <option value="False" {% if not missioncontrole.statut %}selected{% endif %}>Inactif</option>
              </select>
            </div>
          </div>
          
          <!-- PDF Links Section -->
          {% if missioncontrole.pdf_file %}
          <div class="row mt-4">
            <div class="col-12">
              <div class="card card-light">
                <div class="card-header">
                  <h5 class="card-title mb-0">PDF Généré</h5>
                </div>
                <div class="card-body p-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <a href="{{ missioncontrole.pdf_file.url }}" target="_blank" class="text-decoration-none">
                      <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                      <span>GammePdf</span>
                    </a>
                    <small class="text-muted">Dernière modification</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          <!-- End PDF Links Section -->
          
        </div>
      </div>
    </div>

    <!-- Gamme -->
    <div class="tab-pane fade" id="custom-tabs-four-profile" role="tabpanel">
      <div class="card card-info card-outline mb-4">
        <div class="card-header"><div class="card-title">Gammes Associées</div></div>
        <div class="card-body">

          {% if gammes %}
          <div class="accordion" id="accordionGammes">
            {% for gamme in gammes %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingGamme{{ forloop.counter }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGamme{{ forloop.counter }}">
                  {{ gamme.intitule }} — Version {{ gamme.version }} — {% if gamme.statut %}✔️ Actif{% else %}❌ Inactif{% endif %}
                </button>
              </h2>
              <div id="collapseGamme{{ forloop.counter }}" class="accordion-collapse collapse">
                <div class="accordion-body">

                  {% if forloop.first %}
                  <div class="d-flex gap-2 mb-3">
                    <a class="btn btn-sm btn-outline-warning" data-bs-toggle="collapse" href="#formGamme{{ gamme.id }}">
                      <i class="bi bi-pencil"></i> Modifier cette gamme
                    </a>

                    <a class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" href="#operationsGamme{{ gamme.id }}">
                      Modifier les opérations
                    </a>

                    <button type="button" class="btn btn-sm btn-outline-success" onclick="showAddOperationForm('{{ gamme.id }}')">
                      <i class="bi bi-plus-circle"></i> Ajouter opération
                    </button>

                    <a class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" href="#tableOperationsGamme{{ gamme.id }}">
                      Afficher les opérations
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#photoDefautModal{{ gamme.id }}">
                      <i class="bi bi-camera"></i> ajouter des images de defaut
                    </button>
                  </div>

                  <!-- Modifier gamme -->
                  <div class="collapse mb-3" id="formGamme{{ gamme.id }}">
                    <div class="card card-light">
                      <div class="card-body">
                        <div class="mb-3">
                          <label class="form-label">Intitulé</label>
                          <input type="text" class="form-control" name="{{ gamme.id }}-intitule" value="{{ gamme.intitule }}">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">No Incident</label>
                          <input type="text" class="form-control" name="{{ gamme.id }}-No_incident" value="{{ gamme.No_incident }}">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Statut</label>
                          <select class="form-select" name="{{ gamme.id }}-statut">
                            <option value="True" {% if gamme.statut %}selected{% endif %}>Actif</option>
                            <option value="False" {% if not gamme.statut %}selected{% endif %}>Inactif</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Table des opérations -->
                  <div class="collapse mb-3" id="operationsGamme{{ gamme.id }}">
                    <div class="table-responsive">
                      <table class="table table-striped table-bordered align-middle text-center">
                        <thead class="table-light">
                          <tr>
                            <th style="width: 15%;">Titre</th>
                            <th style="width: 10%;">Ordre</th>
                            <th style="width: 20%;">Description</th>
                            <th style="width: 20%;">Critères</th>
                            <th style="width: 20%;">Photos</th>
                            <th style="width: 15%;">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for op in gamme.operationcontrole_set.all %}
                          <tr data-op-id="{{ op.id }}">
                            <td>
                              <input type="text" class="form-control form-control-sm" name="{{ op.id }}-titre" value="{{ op.titre }}">
                            </td>
                            <td>
                              <input type="number" class="form-control form-control-sm" name="{{ op.id }}-ordre" value="{{ op.ordre }}">
                            </td>
                            <td>
                              <textarea class="form-control form-control-sm" rows="2" name="{{ op.id }}-description">{{ op.description }}</textarea>
                            </td>
                            <td>
                              <textarea class="form-control form-control-sm" rows="2" name="{{ op.id }}-criteres">{{ op.criteres }}</textarea>
                            </td>
                            <td>
                              <div class="photo-forms-container d-flex flex-wrap gap-2 justify-content-center">
                                {% for photo in op.photooperation_set.all %}
                                <div class="photo-cell" id="photoCell-{{ photo.id }}">
                                  <img src="{{ photo.image.url }}" class="operation-photo" alt="Photo de l'opération" onclick="zoomPhoto(this)">
                                  <div class="photo-description">
                                    <input type="text" class="form-control form-control-sm" name="photo_{{ photo.id }}_description" value="{{ photo.description }}">
                                  </div>
                                  <button type="button" class="photo-delete-btn" onclick="markPhotoDelete('{{ photo.id }}', this)">
                                    <i class="bi bi-x-lg"></i>
                                  </button>
                                </div>
                                {% endfor %}
                                <div id="newPhotoFormsContainer-{{ op.id }}"></div>
                                <button type="button" class="photo-add-btn" onclick="addNewPhotoForm('{{ op.id }}')" id="addPhotoBtn{{ op.id }}">
                                  <i class="bi bi-plus-lg"></i>
                                </button>
                              </div>
                            </td>
                            <td>
                              <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOperation('{{ op.id }}', event)">
                                <i class="bi bi-trash"></i> Supprimer
                              </button>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                      
                    </div>
                  </div>

                  <!-- Ajouter opération (formulaire) -->
                  <div class="collapse mb-3" id="addOperationGamme{{ gamme.id }}">
                    <div class="card card-light mb-3 operation-form" id="newOpForm-{{ gamme.id }}-0" style="display: none;">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                          <h6 class="card-title">Nouvelle opération</h6>
                          <button type="button" class="btn-close" onclick="removeOperationForm(this)"></button>
                        </div>
                        <div class="d-flex flex-column gap-3">
                          <div>
                            <label class="form-label">Titre</label>
                            <input type="text" class="form-control" name="newop_{{ gamme.id }}_0_titre">
                          </div>
                          <div>
                            <label class="form-label">Ordre</label>
                            <input type="number" class="form-control" name="newop_{{ gamme.id }}_0_ordre">
                          </div>
                          <div>
                            <label class="form-label">Description</label>
                            <textarea class="form-control" rows="3" name="newop_{{ gamme.id }}_0_description"></textarea>
                          </div>
                          <div>
                            <label class="form-label">Critères</label>
                            <textarea class="form-control" rows="3" name="newop_{{ gamme.id }}_0_criteres"></textarea>
                          </div>
                        </div>

                        <!-- Container new photos for this new op -->
                        <div class="photo-forms-container" id="newOpPhotoFormsContainer-{{ gamme.id }}_0"></div>

                        <button type="button" class="btn btn-outline-secondary btn-sm mt-3" 
                                onclick="event.stopPropagation(); addNewOpPhotoForm('{{ gamme.id }}', 0, event)" 
                                id="addNewOpPhotoBtn{{ gamme.id }}_0">
                          <i class="bi bi-camera"></i> Ajouter une photo
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Table opérations -->
                  <div class="collapse" id="tableOperationsGamme{{ gamme.id }}">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Titre</th>
                          <th>Ordre</th>
                          <th>Description</th>
                          <th>Critères</th>
                          <th>Photo</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for op in gamme.operationcontrole_set.all %}
                        <tr data-op-id="{{ op.id }}">
                          <td>{{ op.titre }}</td>
                          <td>{{ op.ordre }}</td>
                          <td>{{ op.description }}</td>
                          <td>{{ op.criteres }}</td>
                          <td>
                            {% if op.photooperation_set.all %}
                              {% for photo in op.photooperation_set.all %}
                              <div class="photo-cell">
                                <img src="{{ photo.image.url }}" class="operation-photo" alt="Photo de l'opération" onclick="zoomPhoto(this)">
                                <div class="photo-description">{{ photo.description }}</div>
                              </div>
                              {% endfor %}
                            {% else %}
                              <span class="text-muted">Pas de photo</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>

                  {% else %}
                  <!-- Non-last gammes: only show afficher les opérations -->
                  <div class="d-flex gap-2 mb-3">
                    <a class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" href="#tableOperationsGamme{{ gamme.id }}">
                      Afficher les opérations
                    </a>
                  </div>
                  <div class="collapse" id="tableOperationsGamme{{ gamme.id }}">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Titre</th>
                          <th>Ordre</th>
                          <th>Description</th>
                          <th>Critères</th>
                          <th>Photo</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for op in gamme.operationcontrole_set.all %}
                        <tr data-op-id="{{ op.id }}">
                          <td>{{ op.titre }}</td>
                          <td>{{ op.ordre }}</td>
                          <td>{{ op.description }}</td>
                          <td>{{ op.criteres }}</td>
                          <td>
                            {% if op.photooperation_set.all %}
                              {% for photo in op.photooperation_set.all %}
                              <div class="photo-cell">
                                <img src="{{ photo.image.url }}" class="operation-photo" alt="Photo de l'opération" onclick="zoomPhoto(this)">
                                <div class="photo-description">{{ photo.description }}</div>
                              </div>
                              {% endfor %}
                            {% else %}
                              <span class="text-muted">Pas de photo</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% endif %}

                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center">
            <p class="text-muted">Aucune gamme associée.</p>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="collapse" data-bs-target="#newGammeForm">
              <i class="bi bi-plus-circle"></i> Ajouter une nouvelle gamme
            </button>
          </div>
          {% endif %}

          <!-- Nouvelle gamme -->
          <div class="collapse mt-4" id="newGammeForm">
            <h5>Nouvelle Gamme</h5>
            <div class="mb-3">
              <label class="form-label">Intitulé</label>
              <input type="text" class="form-control" name="gamme_intitule">
            </div>
            <div class="mb-3">
              <label class="form-label">No Incident</label>
              <input type="text" class="form-control" name="gamme_No_incident">
            </div>
            <div class="mb-3">
              <label class="form-label">Statut</label>
              <select class="form-select" name="gamme_statut">
                <option value="True">Actif</option>
                <option value="False">Inactif</option>
              </select>
            </div>

            {{ operation_formset.management_form }}
            <div id="operation-forms-container">
              {% for form in operation_formset %}
              <div class="card card-light mb-3 operation-form" id="newOpForm-{{ forloop.counter0 }}">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="card-title">Opération</h6>
                    <button type="button" class="btn-close" onclick="removeOperationForm(this)"></button>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Titre</label>
                      {{ form.titre }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ordre</label>
                      {{ form.ordre }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Description</label>
                      {{ form.description }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Critères</label>
                      {{ form.criteres }}
                    </div>
                  </div>

                  <!-- Container new photos for this new form op -->
                  <div class="photo-forms-container" id="newOpPhotoFormsContainerForm{{ forloop.counter0 }}"></div>

                  <button type="button" class="btn btn-outline-secondary btn-sm mt-3" 
                          onclick="event.stopPropagation(); addNewOpPhotoFormForForm('{{ forloop.counter0 }}', event);" 
                          id="addNewOpPhotoBtnForm{{ forloop.counter0 }}">
                    <i class="bi bi-camera"></i> Ajouter une photo
                  </button>
                </div>
              </div>
              {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-primary" onclick="addOperationForm()">
              Ajouter une opération
            </button>
          </div>

        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
          <a href="{% url 'Gamme:missioncontrole_list' %}" class="btn btn-secondary">Annuler</a>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Photo Defaut Modal -->
{% for gamme in gammes %}
<div class="modal fade" id="photoDefautModal{{ gamme.id }}" tabindex="-1" aria-labelledby="photoDefautModalLabel{{ gamme.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="photoDefautModalLabel{{ gamme.id }}">Ajouter des photos de défaut - {{ gamme.intitule }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="photoDefautForm{{ gamme.id }}" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="gamme_id" value="{{ gamme.id }}">
          
          <div class="mb-3">
            <label for="photos" class="form-label">Sélectionner des photos</label>
            <input class="form-control" type="file" id="photos{{ gamme.id }}" name="photos" multiple accept="image/*" required>
            <div class="form-text">Sélectionnez une ou plusieurs images à télécharger.</div>
          </div>
          
          <div class="mb-3">
            <label for="description" class="form-label">Description (optionnelle)</label>
            <input type="text" class="form-control" id="description{{ gamme.id }}" name="description" placeholder="Description des défauts">
          </div>
          
          <div class="d-flex justify-content-between align-items-center">
            <div id="uploadStatus{{ gamme.id }}" class="text-muted"></div>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-upload"></i> Télécharger
            </button>
          </div>
        </form>
        
        <hr>
        
        <h6>Photos existantes</h6>
        <div id="existingPhotos{{ gamme.id }}" class="row g-2">
          {% for photo in gamme.defaut_photos.all %}
          <div class="col-md-3 col-6">
            <div class="card h-100">
              <div class="position-relative" style="height: 120px; overflow: hidden;">
                <img src="{{ photo.image.url }}" class="card-img-top h-100 w-100" alt="{{ photo.description }}" style="object-fit: cover; cursor: pointer;" onclick="zoomPhoto(this)">
                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                        onclick="event.stopPropagation(); deletePhotoDefaut('{{ photo.id }}', this)" 
                        title="Supprimer"
                        data-photo-id="{{ photo.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
              <div class="card-body p-2">
                <p class="card-text small text-muted mb-0">
                  <i class="bi bi-calendar3 me-1"></i> {{ photo.date_ajout|date:"d/m/Y H:i" }}
                </p>
                {% if photo.description %}
                <p class="card-text small mb-0 mt-1">{{ photo.description }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12">
            <div class="text-center p-4 border rounded bg-light">
              <i class="bi bi-images fs-1 text-muted mb-2"></i>
              <p class="text-muted mb-0">Aucune photo de défaut pour l'instant.</p>
              <p class="small text-muted mt-2">Utilisez le formulaire ci-dessus pour ajouter des photos.</p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Zoom overlay -->
<div class="zoom-overlay" id="photoZoom" role="dialog" aria-modal="true" aria-labelledby="zoomedImage">
  <button class="zoom-close-btn" aria-label="Close zoom" onclick="closeZoom()">×</button>
  <img src="" class="zoom-image" id="zoomedImage" alt="Photo agrandie">
  <div class="zoom-description"></div>
</div>

<script>
  let photoCount = {};
  let newOpCount = 1; // for new ops in new gamme form
  let newOpPhotoCount = {};

  // Remove operation function - Direct deletion with AJAX
  function removeOperation(opId, event) {
    event.preventDefault(); // Prevent default form submission
    event.stopPropagation(); // Stop event bubbling
    
    if (!confirm('Êtes-vous sûr de vouloir supprimer cette opération ?')) {
      return;
    }
    
    const url = `/gamme/operationcontrole/${opId}/delete/`;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    const deleteButton = event.target.closest('button');
    const originalText = deleteButton.innerHTML;
    deleteButton.disabled = true;
    deleteButton.innerHTML = '<i class="bi bi-hourglass"></i>';

    const row = deleteButton.closest('tr');
    row.style.opacity = '0.5';
    row.style.transition = 'opacity 0.3s ease-out';

    // Send the delete request with AJAX
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest',
        'X-Requested-With': 'XMLHttpRequest'  // This header tells Django it's an AJAX request
      },
      // We don't need to send any data, just the CSRF token
    })
    .then(response => {
      // Don't try to parse JSON, just check if the request was successful
      if (response.ok) {
        // If successful, remove the row
        row.style.opacity = '0';
        setTimeout(() => {
          row.remove();
          // Update row numbers if needed
          const table = document.querySelector('table');
          if (table) {
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
              const numberCell = row.querySelector('td:first-child');
              if (numberCell) {
                numberCell.textContent = index + 1;
              }
            });
          }
        }, 300);
      } else {
        // If not successful, show error
        throw new Error('Server returned an error');
      }
    })
    
  }

  // Add new photo input for existing operation
  function addNewPhotoForm(opId) {
    const container = document.getElementById(`newPhotoFormsContainer-${opId}`);
    if (!container) return;
    
    const photoIndex = container.querySelectorAll('.photo-form-group').length;
    const formGroup = document.createElement('div');
    formGroup.className = 'photo-form-group mb-2';
    formGroup.innerHTML = `
      <div class="input-group">
        <input type="file" class="form-control form-control-sm" 
               name="form-${opId}-photo-${photoIndex}-image" accept="image/*" required>
        <input type="text" class="form-control form-control-sm" 
               name="form-${opId}-photo-${photoIndex}-description" 
               placeholder="Description (optionnelle)">
        <button type="button" class="btn btn-outline-danger btn-sm" 
                onclick="this.closest('.photo-form-group').remove(); updatePhotoCounter('${opId}');">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;
    
    container.appendChild(formGroup);
    updatePhotoCounter(opId);
  }

  // Add new photo input for new operation in gamme add form
  function addNewOpPhotoForm(gammeId, opIndex, event) {
    // Prevent multiple triggers
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    const container = document.getElementById(`newOpPhotoFormsContainer-${gammeId}_${opIndex}`);
    if (!container) {
      console.error('Container not found:', `newOpPhotoFormsContainer-${gammeId}_${opIndex}`);
      return;
    }

    // Find the next available photo index
    let photoIndex = 0;
    const usedIndices = new Set();
    const inputs = container.querySelectorAll('input[type="file"]');
    
    inputs.forEach(input => {
      const match = input.name.match(/newop_\d+_\d+_photo_(\d+)_/);
      if (match) {
        usedIndices.add(parseInt(match[1]));
      }
    });
    
    // Find the first available index
    while (usedIndices.has(photoIndex)) {
      photoIndex++;
    }
    
    if (photoIndex >= 5) {
      alert('Maximum de 5 photos par opération atteint');
      return;
    }
    
    // Create form group
    const formGroup = document.createElement('div');
    formGroup.className = 'photo-form-group mb-2';
    
    // Create the file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.className = 'form-control form-control-sm';
    fileInput.name = `newop_${gammeId}_${opIndex}_photo_${photoIndex}_image`;
    fileInput.accept = 'image/*';
    fileInput.required = false;
    
    // Add change event for debugging
    fileInput.addEventListener('change', function() {
      console.log('File selected:', this.name, 'File:', this.files[0]);
    });
    
    // Create description input
    const descInput = document.createElement('input');
    descInput.type = 'text';
    descInput.className = 'form-control form-control-sm';
    descInput.name = `newop_${gammeId}_${opIndex}_photo_${photoIndex}_description`;
    descInput.placeholder = 'Description (optionnelle)';
    
    // Create remove button
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm';
    removeBtn.innerHTML = '<i class="bi bi-x"></i>';
    removeBtn.onclick = function() {
      container.removeChild(formGroup);
      updatePhotoCounters();
    };
    
    // Create input group
    const inputGroup = document.createElement('div');
    inputGroup.className = 'input-group';
    
    // Append elements
    inputGroup.appendChild(fileInput);
    inputGroup.appendChild(descInput);
    inputGroup.appendChild(removeBtn);
    formGroup.appendChild(inputGroup);
    container.appendChild(formGroup);
    
    // Debug log
    console.log('Added photo input with name:', fileInput.name);
    
    // Return false to prevent default behavior
    return false;
  }

  // Add new photo input for operation formset in new gamme form
  function addNewOpPhotoFormForForm(opIndex, event) {
    // Prevent multiple triggers
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    const container = document.getElementById(`newOpPhotoFormsContainerForm${opIndex}`);
    if (!container) return;

    // Count existing photos
    const photoCount = container.querySelectorAll('.photo-form-group').length;
    if (photoCount >= 5) {
      alert('Maximum de 5 photos par opération atteint');
      return;
    }

    const formGroup = document.createElement('div');
    formGroup.className = 'photo-form-group mb-2';
    formGroup.innerHTML = `
      <div class="input-group">
        <input type="file" class="form-control form-control-sm" 
               name="form-${opIndex}-photo-${photoCount}-image" accept="image/*" required>
        <input type="text" class="form-control form-control-sm" 
               name="form-${opIndex}-photo-${photoCount}-description" 
               placeholder="Description (optionnelle)">
        <button type="button" class="btn btn-outline-danger btn-sm" 
                onclick="this.closest('.photo-form-group').remove(); updatePhotoCounters();">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;
    
    container.appendChild(formGroup);
    updatePhotoCounters();
    
    // Return false to prevent default behavior
    return false;
  }

  // Remove operation form (new only)
  function removeOperationForm(btn) {
    const card = btn.closest('.operation-form');
    if(card){
      card.remove();
    }
  }

  // Simple counter for operation forms
  let operationCounter = 0;

  // Add a new operation form
  function showAddOperationForm(gammeId) {
    const container = document.getElementById(`addOperationGamme${gammeId}`);
    
    // Check if this is the first time adding an operation (default form is still hidden)
    const isFirstOperation = !container.querySelector('.operation-form:not([style*="display: none"])');
    
    if (isFirstOperation) {
      // Show the default form
      const defaultForm = container.querySelector('.operation-form');
      if (defaultForm) {
        defaultForm.style.display = 'block';
        // Ensure the container is visible
        const bsCollapse = bootstrap.Collapse.getInstance(container) || new bootstrap.Collapse(container);
        if (!container.classList.contains('show')) {
          bsCollapse.show();
        }
        return;
      }
    }
    
    // For subsequent operations, create a new form
    operationCounter++;
    
    // Get the first form as a template
    const template = container.querySelector('.operation-form');
    if (!template) return;
    
    // Create a new form
    const newForm = template.cloneNode(true);
    newForm.id = `newOpForm-${gammeId}-${operationCounter}`;
    newForm.style.display = 'block';
    
    // Update all form fields
    const formInputs = newForm.querySelectorAll('input, textarea, select');
    formInputs.forEach(input => {
      if (input.name) {
        // Handle file inputs differently to maintain file data
        if (input.type === 'file') {
          // For file inputs, create a new input with the correct name
          const newInput = document.createElement('input');
          newInput.type = 'file';
          newInput.name = input.name.replace(/newop_\d+_\d+_/, `newop_${gammeId}_${operationCounter}_`);
          newInput.className = input.className;
          newInput.multiple = input.multiple;
          newInput.accept = 'image/*';
          
          // Add an event listener to track when files are selected
          newInput.addEventListener('change', function() {
            console.log(`File selected for ${this.name}:`, this.files[0]);
          });
          
          // Replace the old input with the new one
          input.parentNode.replaceChild(newInput, input);
        } else {
          // For non-file inputs, update the name and clear the value
          input.name = input.name.replace(/newop_\d+_\d+_/, `newop_${gammeId}_${operationCounter}_`);
          if (input.type !== 'button' && input.type !== 'submit') {
            input.value = '';
          }
        }
      }
    });
    
    // Update any photo container IDs
    const photoContainers = newForm.querySelectorAll('[id^="newPhotoFormsContainer-"]');
    photoContainers.forEach(container => {
      container.id = `newPhotoFormsContainer-${gammeId}-${operationCounter}`;
    });
    
    // Update any add photo buttons
    const addPhotoButtons = newForm.querySelectorAll('[onclick^="addNewOpPhotoForm"]');
    addPhotoButtons.forEach(btn => {
      btn.setAttribute('onclick', `addNewOpPhotoForm(${gammeId}, ${operationCounter}, event)`);
    });
    
    // Set the order field to the next available number
    const orderInput = newForm.querySelector('input[name$="_ordre"]');
    if (orderInput) {
      // Get all existing order values to find the next available number
      const existingOrders = Array.from(container.querySelectorAll('input[name$="_ordre"]'))
        .map(input => parseInt(input.value) || 0)
        .filter(val => !isNaN(val) && val > 0);
      
      const maxOrder = existingOrders.length > 0 ? Math.max(...existingOrders) : 0;
      orderInput.value = maxOrder + 1;
    }
    
    // Add after the last form
    container.appendChild(newForm);
    
    // Ensure the container is visible
    const bsCollapse = bootstrap.Collapse.getInstance(container) || new bootstrap.Collapse(container);
    if (!container.classList.contains('show')) {
      bsCollapse.show();
    }
  }

  // Add new operation form in "Nouvelle Gamme" form
  function addOperationForm() {
    const container = document.getElementById('operation-forms-container');
    if (!container) return;

    const formIndex = container.children.length;
    const div = document.createElement('div');
    div.className = 'card card-light mb-3 operation-form';
    div.id = `newOpForm-${formIndex}`;

    div.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h6 class="card-title">Opération</h6>
          <button type="button" class="btn-close" onclick="removeOperationForm(this)"></button>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Titre</label>
            <input type="text" name="form-${formIndex}-titre" class="form-control" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Ordre</label>
            <input type="number" name="form-${formIndex}-ordre" class="form-control" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Description</label>
            <textarea name="form-${formIndex}-description" class="form-control" required></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Critères</label>
            <textarea name="form-${formIndex}-criteres" class="form-control" required></textarea>
          </div>
        </div>
        <div class="photo-forms-container" id="newOpPhotoFormsContainerForm${formIndex}"></div>
        <button type="button" class="btn btn-outline-secondary btn-sm mt-3" onclick="addNewOpPhotoFormForForm(${formIndex})">
          <i class="bi bi-camera"></i> Ajouter une photo
        </button>
      </div>
    `;
    container.appendChild(div);

    // Update management form TOTAL_FORMS
    const totalFormsInput = document.querySelector('#id_form-TOTAL_FORMS');
    if(totalFormsInput){
      totalFormsInput.value = parseInt(totalFormsInput.value) + 1;
    }
  }

  // Mark photo for deletion (hide card and add hidden input)
  function markPhotoDelete(photoId, btn) {
    const photoCard = document.getElementById(`photoCell-${photoId}`);
    if(photoCard){
        photoCard.style.display = 'none';

        // Add hidden input to mark delete
        let input = document.createElement('input');
        input.type = 'hidden';
        input.name = `photo_${photoId}_DELETE`;
        input.value = 'on';

        photoCard.appendChild(input);
        const opId = photoCard.closest('.photo-forms-container').querySelector('[id^=newPhotoFormsContainer-]').id.split('-')[1];
        updatePhotoCounter(opId);
    }
  }

  // Zoom photo function
  function zoomPhoto(img) {
    const overlay = document.getElementById('photoZoom');
    const zoomedImage = document.getElementById('zoomedImage');
    const zoomDesc = overlay.querySelector('.zoom-description');

    zoomedImage.src = img.src;

    let desc = '';

    // For photos in table or card
    const photoCell = img.closest('.photo-cell');
    if (photoCell) {
      const descElem = photoCell.querySelector('.photo-description');
      if(descElem){
        desc = descElem.textContent;
      }
    } else {
      // For photos in form inputs: try to find sibling input description
      const cardBody = img.closest('.card-body');
      if (cardBody) {
        const inputDesc = cardBody.querySelector('input[type="text"]');
        if(inputDesc){
          desc = inputDesc.value;
        }
      }
    }

    zoomDesc.textContent = desc || '';

    overlay.style.display = 'flex';
  }

  function updatePhotoCounter(opId) {
    const container = document.getElementById(`newPhotoFormsContainer-${opId}`).closest('.photo-forms-container');
    const addButton = document.getElementById(`addPhotoBtn${opId}`);
    const visiblePhotos = container.querySelectorAll('.photo-cell:not([style*="display: none"])').length;

    let counter = container.querySelector('.photo-counter');
    if (!counter) {
        counter = document.createElement('small');
        counter.className = 'photo-counter text-muted d-block mt-1';
        container.appendChild(counter);
    }

    counter.textContent = `${visiblePhotos}/5 photos`;

    if (visiblePhotos >= 5) {
        addButton.disabled = true;
        addButton.classList.add('disabled');
    } else {
        addButton.disabled = false;
        addButton.classList.remove('disabled');
    }
  }

  // Initialize photo counters when page loads
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id^=newPhotoFormsContainer-]').forEach(container => {
        const opId = container.id.split('-')[1];
        updatePhotoCounter(opId);
    });
  });

  // Close zoom overlay
  function closeZoom() {
    const overlay = document.getElementById('photoZoom');
    overlay.style.display = 'none';
  }

  // Handle photo upload form submission
  document.querySelectorAll('[id^=photoDefautForm]').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const gammeId = formData.get('gamme_id');
      const statusEl = document.getElementById(`uploadStatus${gammeId}`);
      
      statusEl.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Chargement...</span></div> Téléchargement...';
      
      const uploadUrl = '{% url "Gamme:upload_photo_defaut" %}';
      fetch(uploadUrl, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          statusEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Téléchargement réussi</span>';
          // Reload the page to show the new photos
          setTimeout(() => window.location.reload(), 1000);
        } else {
          statusEl.innerHTML = `<span class="text-danger">Erreur: ${data.error || 'Erreur inconnue'}</span>`;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        statusEl.innerHTML = '<span class="text-danger">Erreur lors du téléchargement</span>';
      });
    });
  });

  // Delete photo defaut
  window.deletePhotoDefaut = function(photoId, btn) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer cette photo ?')) return;
    
    const card = btn.closest('.col-md-3');
    card.style.opacity = '0.5';
    
    fetch(`/gamme/photo-defaut/${photoId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        card.remove();
        // If no photos left, show message
        if (!document.querySelector(`#existingPhotos${data.gamme_id} .col-md-3`)) {
          document.querySelector(`#existingPhotos${data.gamme_id}`).innerHTML = 
            '<div class="col-12"><p class="text-muted">Aucune photo de défaut pour l\'instant.</p></div>';
        }
      } else {
        alert('Erreur lors de la suppression: ' + (data.error || 'Erreur inconnue'));
        card.style.opacity = '1';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Erreur lors de la suppression');
      card.style.opacity = '1';
    });
  };

  // Custom form submission handler
  function submitForm(event) {
    // Prevent default form submission if called directly
    if (event) {
      event.preventDefault();
    }
    
    const form = document.getElementById('missionForm');
    console.log('=== Form submission started ===');
    
    // Create FormData object
    const formData = new FormData(form);
    
    // Manually add all operation fields to ensure they're included
    document.querySelectorAll('input[name$="-titre"], input[name$="-ordre"], textarea[name$="-description"], textarea[name$="-criteres"]').forEach(field => {
      if (!formData.has(field.name)) {
        formData.append(field.name, field.value);
      }
    });
    
    // Add photo descriptions
    document.querySelectorAll('input[name^="photo_"][name$="_description"]').forEach(field => {
      if (!formData.has(field.name)) {
        formData.append(field.name, field.value);
      }
    });
    
    // Log all form data for debugging
    console.log('FormData entries:');
    for (let [key, value] of formData.entries()) {
      if (value instanceof File) {
        console.log(`${key}: [File] ${value.name} (${value.size} bytes, ${value.type})`);
      } else {
        console.log(`${key}: ${value}`);
      }
    }
    
    // Check form validity
    if (!form.checkValidity()) {
      console.log('Form is invalid');
      form.classList.add('was-validated');
      
      // Find and log all invalid fields
      const invalidFields = form.querySelectorAll(':invalid');
      console.log(`Found ${invalidFields.length} invalid fields:`);
      
      invalidFields.forEach((field, index) => {
        const fieldName = field.name || field.id || 'unknown-field';
        console.log(`  ${index + 1}. ${fieldName}`, {
          value: field.value,
          validity: field.validity,
          required: field.required,
          pattern: field.pattern
        });
      });
      
      // Scroll to first invalid field
      if (invalidFields.length > 0) {
        invalidFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        invalidFields[0].focus();
      }
      
      return false;
    }
    
    console.log('Form is valid, submitting...');
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';
    
    // Submit the form using fetch to handle the response
    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        return response.json().then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            throw new Error(data.message || 'Erreur lors de la sauvegarde');
          }
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Une erreur est survenue lors de la sauvegarde: ' + error.message);
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    });
    
    return false;
  }
  
  // Add form submission handler
  document.getElementById('missionForm').addEventListener('submit', submitForm);

  // Close zoom overlay by clicking outside image or description
  document.getElementById('photoZoom').addEventListener('click', function(e) {
    if(e.target === this) {
      closeZoom();
    }
  });

  function checkForDuplicateOrders() {
    const orderValues = new Map(); // Map to store order values and their input elements
    let hasDuplicates = false;
    
    // Find all order inputs in the form
    const orderInputs = document.querySelectorAll('input[name$="_ordre"], input[name$="-ordre"]');
    
    // Reset previous error states
    document.querySelectorAll('.order-error').forEach(el => el.remove());
    orderInputs.forEach(input => input.classList.remove('is-invalid'));
    
    // Check each order input
    for (const input of orderInputs) {
      const value = input.value.trim();
      if (value === '' || isNaN(value)) continue; // Skip empty or invalid numbers
      
      if (orderValues.has(value)) {
        // Found a duplicate
        hasDuplicates = true;
        // Mark both inputs as invalid
        input.classList.add('is-invalid');
        orderValues.get(value).classList.add('is-invalid');
        
        // Add error message if not already present
        if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('order-error')) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'order-error invalid-feedback d-block';
          errorDiv.textContent = 'Cette valeur d\'ordre est déjà utilisée. Veuillez en choisir une autre.';
          input.parentNode.insertBefore(errorDiv, input.nextSibling);
        }
      } else {
        orderValues.set(value, input);
      }
    }
    
    return hasDuplicates;
  }
  
  // Add event listeners to order inputs for real-time validation
  document.addEventListener('input', function(e) {
    if (e.target.matches('input[name$="_ordre"], input[name$="-ordre"]')) {
      // Add a small delay to allow the value to update
      setTimeout(() => {
        const input = e.target;
        input.classList.remove('is-invalid');
        const errorDiv = input.nextElementSibling;
        if (errorDiv && errorDiv.classList.contains('order-error')) {
          errorDiv.remove();
        }
        checkForDuplicateOrders();
      }, 100);
    }
  });

  // Form validation before submission
  document.querySelector('form').addEventListener('submit', function(e) {
    // First, ensure all order fields have valid numbers
    const orderInputs = this.querySelectorAll('input[name$="_ordre"], input[name$="-ordre"]');
    for (const input of orderInputs) {
      if (input.value.trim() === '' || isNaN(input.value)) {
        input.value = '0';
      }
    }
    
    // Check for duplicate order numbers
    if (checkForDuplicateOrders()) {
      e.preventDefault();
      // Scroll to the first error
      const firstError = document.querySelector('.is-invalid');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return false;
    }
    
    // Also check new operation forms for empty values
    const newOrderInputs = this.querySelectorAll('input[name^="newop_"]');
    for (const input of newOrderInputs) {
      if (input.name.endsWith('_ordre') && (input.value.trim() === '' || isNaN(input.value))) {
        input.value = '0';
      }
    }
  });
</script>

{% endblock %}